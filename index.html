<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>TWGrid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body, #map { height: 100%; margin: 0; }

    :root{
      /* 桌機/平板預設面板寬度（可被拖曳覆蓋）*/
      --panel-width: 700px;
      --panel-min: 220px;
      --panel-max: 780px;
    }

    .panel {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
      min-width: var(--panel-min);
      width: var(--panel-width);
      max-width: var(--panel-max);
      box-sizing: border-box;
    }

    /* 右側拖曳拉把 */
    .panel-resizer{
      position: absolute;
      top: 0; right: -4px;
      width: 8px; height: 100%;
      cursor: ew-resize;
      background: linear-gradient(to right, transparent 0%, rgba(0,0,0,0.05) 50%, transparent 100%);
      border-radius: 4px;
    }
    .panel.resizing, body.resizing { user-select: none; cursor: ew-resize; }

    .panel-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .panel-header .title { font-weight:700; font-size:18px; }
    .panel-header button { border: 1px solid #ccc; background:#f9f9f9; border-radius:6px; padding:4px 8px; cursor:pointer; }
    .panel-body { margin-top:6px; }
    .panel label { font-size: 16px; color: #555; display:block; margin-top: 6px; }
    .panel select, .panel button, .panel input[type="number"] {
      width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; font-size: 16px;
    }
    .dataset-box { max-height: 180px; overflow: auto; border: 1px solid #ddd; border-radius: 6px; padding: 6px; margin-top: 6px; }
    .dataset-item { display: flex; align-items: center; gap: 6px; margin: 4px 0; font-size: 16px; }
    .dataset-item .name { flex: 1 1 auto; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .dataset-item .count { color: #666; font-size: 16px; }

    .legend {
      line-height: 1.2; background: #fff; padding: 8px; border: 1px solid #ccc; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15); position:absolute; right:10px; bottom:60px;
      z-index: 1100;
    }
    .legend .row { display: flex; align-items: center; margin: 4px 0; }
    .legend .swatch { width: 14px; height: 14px; margin-right: 6px; border: 1px solid rgba(0,0,0,.2); }
    

    .credit {
      position: absolute; right: 10px; bottom: 20px; background: rgba(255,255,255,.9);
      padding: 8px 10px; border-radius: 8px; font-size: 16px; border: 1px solid #ccc;
      z-index: 1009; /* 確保不被面板/地圖蓋住 */
    }
    /* ⇩ 新增：資料來源（左下角） */
    .source {
      position: absolute; left: 10px; bottom: 10px; background: rgba(255,255,255,.9);
      padding: 8px 10px; border-radius: 8px; font-size: 16px; border: 1px solid #ccc;
      max-width: min(60vw, 700px);
      z-index: 1100; /* 確保不被面板/地圖蓋住 */
    }
    .source a { text-decoration: none; }
    .source a:hover { text-decoration: underline; }

    .hint { font-size: 16px; color: #666; margin-top: 6px; }

    /* 收合狀態 */
    .panel.collapsed { padding:8px; min-width:auto; width:auto; }
    .panel.collapsed .panel-body, .panel.collapsed .panel-resizer { display:none; }
    .panel.collapsed .panel-header .title { font-size:16px; }

    /* 手機自適應（小於 768px） */
    @media (max-width: 768px) {
      :root{ --panel-width: calc(100vw - 24px); --panel-min: 220px; --panel-max: none; }
      .panel { left: 12px; right: 12px; width: calc(100% - 24px) !important; }
      .panel-resizer{ display:none; }               /* 手機隱藏拉把 */
      .dataset-box { max-height: min(45vh, 260px); }/* 手機清單用視窗高度 */
      .legend { right: 8px; bottom: 56px; }         /* 讓出來源區塊空間 */
      .credit { right: 8px; bottom: 8px; }
      .source { left: 8px; bottom: 8px; font-size: 14px; max-width: calc(100vw - 140px); }
      .leaflet-tooltip { font-size: 14px; line-height: 1.2; }
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="panel" id="controlPanel">
  <div class="panel-header">
    <div class="title">TWGrid</div>
    <button id="collapseBtn" title="收合">收合</button>
  </div>

  <div class="panel-body">
    <label for="csvSelect">資料來源</label>
    <select id="csvSelect">
      <option value="鵯科" selected>TBIA-鵯科</option>
      <option value="赤蛙">TBIA-赤蛙</option>
      <option value="樹蛙">TBIA-樹蛙</option>
    </select>

    <label for="scaleSelect">網格尺度</label>
    <select id="scaleSelect">
      <option value="1km">1 公里</option>
      <option value="5km" selected>5 公里</option>
      <option value="10km">10 公里</option>
    </select>

    <!-- 只留「基數」 -->
    <div style="display:flex; gap:8px;">
      <div style="flex:1;">
        <label for="stepInput">著色步長（基數）</label>
        <input id="stepInput" type="number" min="1" step="1" value="50" />
      </div>
    </div>

    <label>資料集（依當前來源總筆數排序，僅顯示 Top10）</label>
    <div class="dataset-box" id="datasetBox"></div>
    <div style="display:flex; gap:8px; margin-top:6px;">
      <button id="selectAllBtn">全選</button>
      <button id="clearAllBtn">全不選</button>
    </div>

    <label for="topNInput">Tooltip 顯示物種 Top N</label>
    <input id="topNInput" type="number" min="1" max="99" step="1" value="10" />

    <div class="hint">顏色以固定門檻分級，滑到方格才顯示 Tooltip（顯示所選資料集合併後的物種排名）。</div>
  </div>

  <!-- 拉把 -->
  <div class="panel-resizer" id="panelResizer" aria-hidden="true"></div>
</div>

<div id="legend" class="legend"></div>
<div class="credit">底圖 © OpenStreetMap</div>
<!-- 資料來源（動態顯示目前 CSV 與已選資料集數量） -->
<div class="source" id="sourceFooter">
  資料來源：<a href="https://tbiadata.tw/" target="_blank" rel="noopener noreferrer">TBIA</a>
  （目前：TBIA-鵯科，已選 0 個資料集）
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* 檔名對應（每個資料來源都各有 1/5/10km） */
const FILES = {
  "鵯科": { "1km": "grid_by_ds_species_1km_bird_.geojson", "5km": "grid_by_ds_species_5km_bird_.geojson", "10km": "grid_by_ds_species_10km_bird_.geojson" },
  "赤蛙": { "1km": "grid_by_ds_species_1km_red_.geojson",  "5km": "grid_by_ds_species_5km_red_.geojson",  "10km": "grid_by_ds_species_10km_red_.geojson"  },
  "樹蛙": { "1km": "grid_by_ds_species_1km_tree_.geojson", "5km": "grid_by_ds_species_5km_tree_.geojson", "10km": "grid_by_ds_species_10km_tree_.geojson" },
};

const MAP_CENTER = [23.7, 121.0];
const MAP_ZOOM   = 7;

const map = L.map('map', { zoomSnap: 0.5 }).setView(MAP_CENTER, MAP_ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '© OSM'
}).addTo(map);

// 狀態
let gridLayer = null;
let gridIdKey = null;
let currentData = null;
let top10Datasets = [];
let selectedDatasets = new Set();
let suppressAutoSelect = false;   // 避免「全不選」後又自動全選
const cache = new Map();

// UI
const panel        = document.getElementById('controlPanel');
const collapseBtn  = document.getElementById('collapseBtn');
const resizer      = document.getElementById('panelResizer');
const csvSelect    = document.getElementById('csvSelect');
const scaleSelect  = document.getElementById('scaleSelect');
const stepInput    = document.getElementById('stepInput');
const datasetBox   = document.getElementById('datasetBox');
const selectAllBtn = document.getElementById('selectAllBtn');
const clearAllBtn  = document.getElementById('clearAllBtn');
const topNInput    = document.getElementById('topNInput');
const sourceFooter = document.getElementById('sourceFooter');

/* —— 收合面板（文字：收合 / 展開）—— */
collapseBtn.addEventListener('click', () => {
  panel.classList.toggle('collapsed');
  const collapsed = panel.classList.contains('collapsed');
  collapseBtn.textContent = collapsed ? '展開' : '收合';
  collapseBtn.title = collapsed ? '展開' : '收合';
});

/* —— 拖曳調整面板寬度（桌機/平板）—— */
(function enableResize(){
  if (!resizer) return;

  const minW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--panel-min')) || 220;
  const maxW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--panel-max')) || 480;

  let startX = 0, startW = 0, resizing = false;

  const onDown = (clientX) => {
    resizing = true;
    startX = clientX;
    startW = panel.getBoundingClientRect().width;
    document.body.classList.add('resizing');
    panel.classList.add('resizing');
  };
  const onMove = (clientX) => {
    if (!resizing) return;
    const dx = clientX - startX;
    let w = Math.max(minW, Math.min(maxW, Math.round(startW + dx)));
    panel.style.width = w + 'px';
  };
  const onUp = () => {
    resizing = false;
    document.body.classList.remove('resizing');
    panel.classList.remove('resizing');
  };

  // 滑鼠
  resizer.addEventListener('mousedown', (e)=>{ e.preventDefault(); onDown(e.clientX); });
  window.addEventListener('mousemove', (e)=> onMove(e.clientX));
  window.addEventListener('mouseup', onUp);

  // 觸控（平板可能用得到）
  resizer.addEventListener('touchstart', (e)=>{ if (e.touches[0]) onDown(e.touches[0].clientX); }, {passive:true});
  window.addEventListener('touchmove',  (e)=>{ if (e.touches[0]) onMove(e.touches[0].clientX); }, {passive:true});
  window.addEventListener('touchend', onUp);
})();

/* —— 調色盤（5 階固定）—— */
// const PALETTE = ['#eff3ff','#bdd7e7','#6baed6','#2171b5','#08306b'];
const PALETTE = ['#f3e8ff','#d8b4fe','#a78bfa','#7c3aed','#4c1d95'];

/* —— 依「基數 step」決定顏色（0–<step, step–<2*step, …, ≥4*step 共 5 級）—— */
function colorByStep(v, step){
  if (!Number.isFinite(v) || v < step) return PALETTE[0];
  if (v < 2*step) return PALETTE[1];
  if (v < 3*step) return PALETTE[2];
  if (v < 4*step) return PALETTE[3];
  return PALETTE[4]; // ≥ 4*step
}

/* —— 圖例（固定顯示 5 階，不會被最大值影響）—— */
function updateLegendByStep(step, title="所選資料集總筆數") {
  const el = document.getElementById('legend');
  const labels = [
    `0–<${step}`,
    `${step}–<${2*step}`,
    `${2*step}–<${3*step}`,
    `${3*step}–<${4*step}`,
    `≥ ${4*step}`
  ];
  const rows = labels.map((txt, i) =>
    `<div class="row"><div class="swatch" style="background:${PALETTE[i]}"></div><div>${txt}</div></div>`
  );
  el.innerHTML = `<div style="font-weight:600;margin-bottom:6px;">圖例：${title}｜固定步長=${step}｜級數=5</div>${rows.join('')}`;
}

/* —— 計算（依當前 CSV）—— */
function computeTop10Datasets(geojson){
  const totals = {};
  for (const f of geojson.features) {
    const ds = f.properties?.datasets || {};
    for (const [name, obj] of Object.entries(ds)) {
      totals[name] = (totals[name] || 0) + Number(obj?.total || 0);
    }
  }
  const sorted = Object.keys(totals).sort((a,b)=>{
    const da = totals[a]||0, db = totals[b]||0;
    if (db !== da) return db - da;
    return a.localeCompare(b, 'zh-Hant');
  });
  return { top10: sorted.slice(0,10), totals };
}
function selectedTotalForGrid(props){
  const ds = props.datasets || {};
  if (selectedDatasets.size===0) return 0;
  let s = 0;
  for (const name of selectedDatasets) s += Number(ds[name]?.total || 0);
  return s;
}
function speciesCountsForSelected(props){
  const ds = props.datasets || {};
  const acc = {};
  for (const name of selectedDatasets) {
    const sp = ds[name]?.species || {};
    for (const [k,v] of Object.entries(sp)) acc[k] = (acc[k]||0) + Number(v||0);
  }
  return acc;
}
function buildSpeciesRankHTML(props, topN){
  const m = speciesCountsForSelected(props);
  const arr = Object.entries(m).filter(([,v]) => v>0);
  arr.sort((a,b)=>b[1]-a[1]);
  const top = arr.slice(0, topN);
  if (top.length===0) return "";
  const fmt = (s)=> (s.length>10 ? s.slice(0,10)+'…' : s);
  return top.map(([name,cnt],i)=>`${i+1}. ${fmt(name)}(${cnt})`).join('<br>');
}

/* —— 依當前 CSV 重建 Top10 清單（支援全不選時不自動重勾）—— */
function rebuildDatasetList(geojson, {autoSelectIfEmpty=true} = {}){
  const { top10, totals } = computeTop10Datasets(geojson);
  top10Datasets = top10;

  selectedDatasets = new Set([...selectedDatasets].filter(n => top10Datasets.includes(n)));
  if (selectedDatasets.size===0 && autoSelectIfEmpty && !suppressAutoSelect) {
    selectedDatasets = new Set(top10Datasets);
  }

  datasetBox.innerHTML = '';
  for (const name of top10Datasets) {
    const id = `ds_${btoa(encodeURIComponent(name)).replace(/=+$/,'')}`;
    const row = document.createElement('div');
    row.className = 'dataset-item';
    row.innerHTML = `
      <input type="checkbox" id="${id}" ${selectedDatasets.has(name)?'checked':''}>
      <label for="${id}" class="name" title="${name}">${name}</label>
      <span class="count">(${(totals[name]||0).toLocaleString()})</span>`;
    datasetBox.appendChild(row);
    row.querySelector('input').addEventListener('change', e => {
      if (e.target.checked) selectedDatasets.add(name); else selectedDatasets.delete(name);
      renderLayer(currentData);
      updateSourceFooter(); // 勾選變動就更新來源顯示
    });
  }
}

/* —— 格網 ID —— */
function detectGridId(geojson){
  const props = geojson.features[0]?.properties || {};
  const keys = Object.keys(props);
  gridIdKey = keys.includes('Name') ? 'Name'
           : (keys.includes('grid_id') ? 'grid_id'
           : keys.find(k => !['total_count','datasets'].includes(k)) || null);
}

/* —— 更新頁面左下角的「資料來源」內容 —— */
function updateSourceFooter(){
  const csvLabel = csvSelect.options[csvSelect.selectedIndex].textContent.trim();
  const n = selectedDatasets.size;
  sourceFooter.innerHTML =
    `資料來源：<a href="https://tbiadata.tw/" target="_blank" rel="noopener noreferrer">TBIA</a>` +
    `（目前：<b>${csvLabel}</b>，已選 <b>${n}</b> 個資料集）`;
}

/* —— 主繪圖（hover 才顯示 Tooltip；值為 0 完全透明且無邊框、無 tooltip）—— */
function renderLayer(geojson){
  if (gridLayer) { map.removeLayer(gridLayer); gridLayer = null; }
  const step = Math.max(1, Number(stepInput.value)||50);

  gridLayer = L.geoJSON(geojson, {
    style: f => {
      const v = selectedTotalForGrid(f.properties);
      const isZero = v === 0;
      return {
        fillColor: isZero ? 'transparent' : colorByStep(v, step),
        fillOpacity: isZero ? 0 : 0.8,
        color: isZero ? 'transparent' : '#ffffff',
        weight: isZero ? 0 : 0.4
      };
    },
    onEachFeature: (f, lyr) => {
      const v = selectedTotalForGrid(f.properties);
      if (v === 0) {
        // 值為 0：不綁 tooltip、也不做 hover 效果
        return;
      }
      const id = gridIdKey ? (f.properties[gridIdKey] ?? '') : '';
      const selTotal = v;
      const topN = Math.max(1, Math.min(10, Number(topNInput.value)||10));
      const rankHtml = buildSpeciesRankHTML(f.properties, topN);
      const html = `
        <div>
          <div><b>格網：</b>${id}</div>
          <div><b>所選資料集總筆數：</b>${selTotal.toLocaleString()}</div>
          ${rankHtml ? `<div style="margin-top:6px;"><b>物種 Top${topN}：</b><div style="margin-top:4px;">${rankHtml}</div></div>` : '<div style="margin-top:6px; color:#666;">此格無符合所選資料集的物種資料</div>'}
        </div>`;
      lyr.bindTooltip(html, {sticky:true});
      lyr.on({
        mouseover: e => e.target.setStyle({weight:1, color:'#333'}),
        mouseout:  e => e.target.setStyle({weight:0.4, color:'#fff'})
      });
    }
  }).addTo(map);

  updateLegendByStep(step);
}

/* —— 載入當前 CSV + 尺度 —— */
async function loadCurrent(){
  const csvTag = csvSelect.value;
  const scale  = scaleSelect.value;
  const url = FILES[csvTag][scale];
  if (!url) { alert('檔案設定錯誤'); return; }

  if (!cache.has(url)) {
    const res = await fetch(url);
    const data = await res.json();
    cache.set(url, data);
  }
  currentData = cache.get(url);

  detectGridId(currentData);
  selectedDatasets.clear(); // 切換 CSV/尺度時重置
  suppressAutoSelect = false;
  rebuildDatasetList(currentData, {autoSelectIfEmpty:true});
  renderLayer(currentData);
  updateSourceFooter(); // 切換資料時更新來源顯示
}

/* —— 事件 —— */
[csvSelect, scaleSelect].forEach(el => el.addEventListener('change', loadCurrent));
[stepInput, topNInput].forEach(el => el.addEventListener('change', () => renderLayer(currentData)));

selectAllBtn.addEventListener('click', () => {
  selectedDatasets = new Set(top10Datasets);
  suppressAutoSelect = false;
  renderLayer(currentData);
  rebuildDatasetList(currentData, {autoSelectIfEmpty:false});
  updateSourceFooter();
});

clearAllBtn.addEventListener('click', () => {
  selectedDatasets.clear();
  suppressAutoSelect = true; // 避免 rebuild 又自動全選
  renderLayer(currentData);
  rebuildDatasetList(currentData, {autoSelectIfEmpty:false});
  suppressAutoSelect = false;
  updateSourceFooter();
});

// 初始
loadCurrent();
</script>
</body>
</html>
